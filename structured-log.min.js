!function(root,factory){"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?module.exports=factory():root.serilog=factory()}(this,function(){function MessageTemplate(messageTemplate){var self=this;self.raw=messageTemplate,self.tokens=[];for(var res,ptre=/\{@?\w+}/g,textStart=0;null!==(res=ptre.exec(messageTemplate));){res.index!==textStart&&self.tokens.push({text:messageTemplate.slice(textStart,res.index)});var destructure=!1,tok=res[0].slice(1,-1);0===tok.indexOf("@")&&(tok=tok.slice(1),destructure=!0),self.tokens.push({name:tok,destructure:destructure,raw:res[0]}),textStart=ptre.lastIndex}textStart>=0&&textStart<messageTemplate.length&&self.tokens.push({text:messageTemplate.slice(textStart)})}function LogEvent(timestamp,level,messageTemplate,properties){var self=this;self.timestamp=timestamp,self.level=level,self.messageTemplate=messageTemplate,self.properties=properties}function LevelMap(initial){var self=this;if(self.levels={},"OFF"!==initial)for(var sequence=["ERROR","WARNING","INFORMATION","TRACE"],below=!1,i=0;i<sequence.length;++i){var level=sequence[i];self.levels[level]=!below,level===initial&&(below=!0)}}function Pipeline(elements,endWith){var self=this;self.elements=elements,self.endWith=endWith||[];for(var head=function(evt){},makeHead=function(el){var oldHead=head;return function(evt){el(evt,oldHead)}},i=self.elements.length-1;i>=0;--i){var el=self.elements[i];head=makeHead(el)}self.head=head}function LoggerConfiguration(){var self=this,minimumLevel="INFORMATION",pipeline=[],endWith=[];self.pipe=function(element){return pipeline.push(element),self},self.minimumLevel=function(lvl){if(0!==pipeline.length){var lm=new LevelMap(lvl);return self.filter(function(evt){return lm.isEnabled(evt.level)})}return minimumLevel=(lvl||"INFORMATION").toUpperCase(),self},self.writeTo=function(sinkOrEmit,onError){return"function"!=typeof sinkOrEmit.emit&&"function"==typeof sinkOrEmit?self.writeTo({emit:sinkOrEmit,toString:function(){return sinkOrEmit.toString()}},minimumLevel):("function"==typeof sinkOrEmit.end&&endWith.push(sinkOrEmit.end),self.pipe(function(evt,next){try{sinkOrEmit.emit(evt)}catch(err){if("function"==typeof onError)onError(err,evt,next);else if(!evt.properties.isSelfLog){var notification=createEvent("ERROR","Failed to write event {@event} to {sink}: {error}",evt,sinkOrEmit,err);notification.properties.isSelfLog=!0,next(notification)}}next(evt)}))},self.enrich=function(functionOrProperties,destructure){if("object"==typeof functionOrProperties)return self.enrich(function(event){enrich(event,functionOrProperties,destructure)});if("function"==typeof functionOrProperties)return self.pipe(function(evt,next){functionOrProperties(evt),next(evt)});throw new Error("Events can be enriched using either a function, or a hash of properties")},self.filter=function(filter){return self.pipe(function(evt,next){filter(evt)&&next(evt)})},self.createLogger=function(){var levelMap=new LevelMap(minimumLevel);return createLogger(levelMap,new Pipeline(pipeline,endWith))}}function Serilog(){var self=this;self.sink={},self.filter={},self.enrich={},self.filter.selfLog=function(){return function(evt){return evt.properties.isSelfLog}},self.filter.notSelfLog=function(){return function(evt){return!evt.properties.isSelfLog}},self.enrich.withStack=function(){return function(evt){try{throw new Error("getstack")}catch(err){var stack=err.stack;0===stack.indexOf("Error: getstack")&&(stack=stack.slice(stack.indexOf("\n")+1)),stack=stack.replace(/^[ ]+/g,""),evt.properties.hasOwnProperty("stack")||(evt.properties.stack=stack)}}}}var capture=function(o,destructure){return"function"==typeof o?o.toString():"object"==typeof o?destructure||"function"==typeof o.toISOString?o:o.toString():o};MessageTemplate.prototype.bindProperties=function(positionalArgs){for(var self=this,result={},nextArg=0,i=0;i<self.tokens.length&&nextArg<positionalArgs.length;++i){var token=self.tokens[i];if("string"==typeof token.name){var p=positionalArgs[nextArg];result[token.name]=capture(p,token.destructure),nextArg++}}for(;nextArg<positionalArgs.length;){var px=positionalArgs[nextArg];"undefined"!=typeof px&&(result["a"+nextArg]=capture(px)),nextArg++}return result};var toText=function(o){if("undefined"==typeof o)return"undefined";if(null===o)return"null";if("string"==typeof o)return o;if("number"==typeof o)return o.toString();if("boolean"==typeof o)return o.toString();if("function"==typeof o.toISOString)return o.toISOString();if("object"==typeof o){var s=JSON.stringify(o);return s.length>70&&(s=s.slice(0,67)+"..."),s}return o.toString()};MessageTemplate.prototype.render=function(properties){for(var self=this,result=[],i=0;i<self.tokens.length;++i){var token=self.tokens[i];result.push("string"==typeof token.name?properties.hasOwnProperty(token.name)?toText(properties[token.name]):token.raw:token.text)}return result.join("")};var enrich=function(evt,properties,destructure){for(var prop in properties)properties.hasOwnProperty(prop)&&!evt.properties.hasOwnProperty(prop)&&(evt.properties[prop]=capture(properties[prop],destructure))},createEvent=function(level,messageTemplate){var l=Array.prototype.shift.call(arguments),mt=Array.prototype.shift.call(arguments),parsedTemplate=new MessageTemplate(mt),boundProperties=parsedTemplate.bindProperties(arguments);return new LogEvent(new Date,l,parsedTemplate,boundProperties)};LogEvent.prototype.renderedMessage=function(){var self=this;return self.messageTemplate.render(self.properties)},LevelMap.prototype.isEnabled=function(level){var self=this;return self.levels[level||"NONE"]||!1},Pipeline.prototype.execute=function(evt){var self=this;self.head(evt)},Pipeline.prototype.end=function(cb){var self=this,remaining=self.endWith.length;if(0===remaining)return void cb();for(var onEnd=function(){remaining--,0===remaining&&cb()},i=0;i<self.endWith.length;++i)self.endWith[i](onEnd)};var createLogger=function(levelMap,pipeline){var self=function(){self.information.apply(null,arguments)};self.toString=function(){return"Logger"},self.emit=function(evt){levelMap.isEnabled(evt.level)&&pipeline.execute(evt)};var invoke=function(level,messageTemplate,args){if(levelMap.isEnabled(level)){var parsedTemplate=new MessageTemplate(messageTemplate),boundProperties=parsedTemplate.bindProperties(args),evt=new LogEvent(new Date,level,parsedTemplate,boundProperties);pipeline.execute(evt)}};return self.trace=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke("TRACE",mt,arguments)},self.information=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke("INFORMATION",mt,arguments)},self.warning=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke("WARNING",mt,arguments)},self.error=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke("ERROR",mt,arguments)},self.using=function(properties,destructure){var enriched=new Pipeline([function(evt,next){enrich(evt,properties,destructure),pipeline.execute(evt),next(evt)}]);return createLogger(levelMap,enriched)},self.end=function(cb){pipeline.end(cb)},self};return Serilog.prototype.configuration=function(){return new LoggerConfiguration},Serilog.prototype.event=createEvent,new Serilog});
!function(root,factory){"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?module.exports=factory():root.serilog.sink.console=factory()}(this,function(){function ConsoleSink(options){var self=this;self.toString=function(){return"ConsoleSink"},options=options||{};var write={log:function(){},info:function(){},warn:function(){},error:function(){}};"object"==typeof console&&(write.log=function(m,p){p?console.log(m,p):console.log(m)},write.info=function(m,p){p?console.info(m,p):console.info(m)},write.warn=function(m,p){p?console.warn(m,p):console.warn(m)},write.error=function(m,p){p?console.error(m,p):console.error(m)}),self.emit=function(evt){var formatted="";options.timestamp&&(formatted+=evt.timestamp.toISOString().replace("T"," ").replace("Z","")+" "),formatted+="["+evt.level.slice(0,3)+"] "+evt.messageTemplate.render(evt.properties),"ERROR"===evt.level?write.error(formatted,options.complete?evt.properties:null):"WARNING"===evt.level?write.warn(formatted,options.complete?evt.properties:null):"INFORMATION"===evt.level?write.info(formatted,options.complete?evt.properties:null):write.log(formatted,options.complete?evt.properties:null)}}return function(options){return new ConsoleSink(options)}});